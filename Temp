;WITH s AS
(
    SELECT
        ClaimNumber,
        BaseName = LEFT(CC_Extract_file_Name, LEN(CC_Extract_file_Name) - 4)
    FROM dbo.CC_Extract_Staging
    WHERE RIGHT(CC_Extract_file_Name, 4) = '.csv'
)
SELECT
    Prod_CC_Extract_file_Name =
        CASE WHEN LEN(BaseName) > 37 THEN LEFT(BaseName, 33)
             ELSE BaseName
        END,
    COUNT(DISTINCT ClaimNumber) AS Number_of_claims
FROM s
GROUP BY
    CASE WHEN LEN(BaseName) > 37 THEN LEFT(BaseName, 33)
         ELSE BaseName
    END
ORDER BY 1;
