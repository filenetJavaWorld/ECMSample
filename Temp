SELECT 
    CASE 
        -- If it has extra split (_001 etc)
        WHEN LEN(CC_Extract_file_Name) 
             - LEN(REPLACE(CC_Extract_file_Name, '_', '')) = 5
        THEN LEFT(CC_Extract_file_Name,
                  LEN(CC_Extract_file_Name)
                  - CHARINDEX('_', REVERSE(CC_Extract_file_Name))
                  - 3)   -- remove _001.csv
        ELSE LEFT(CC_Extract_file_Name,
                  LEN(CC_Extract_file_Name) - 4)  -- just remove .csv
    END AS Prod_CC_Extract_file_Name,

    COUNT(DISTINCT ClaimNumber) AS Number_of_claims

FROM dbo.CC_Extract_Staging

GROUP BY 
    CASE 
        WHEN LEN(CC_Extract_file_Name) 
             - LEN(REPLACE(CC_Extract_file_Name, '_', '')) = 5
        THEN LEFT(CC_Extract_file_Name,
                  LEN(CC_Extract_file_Name)
                  - CHARINDEX('_', REVERSE(CC_Extract_file_Name))
                  - 3)
        ELSE LEFT(CC_Extract_file_Name,
                  LEN(CC_Extract_file_Name) - 4)
    END

ORDER BY 1;
