require([
    "dojo/_base/declare",
    "dojo/_base/lang",
    "dojo/aspect",
    "dojo/topic",
    "dojo/Deferred",
    "ecm/model/Request",
    "ecm/model/desktop",
    "cNBPropertyEditorEDSPluginDojo/InlineAutocompleteEditor"
], 
function(declare, lang, aspect, topic, Deferred, Request, desktop, InlineAutocompleteEditor) {
    
    console.log("[CNBPropertyEditorEDSPlugin] ====================================");
    console.log("[CNBPropertyEditorEDSPlugin] Initializing plugin...");
    
    var editorConfig = null;
    var configLoaded = false;
    var configLoading = false;
    var configLoadDeferred = null; // Deferred object for waiting on config
    var configLoadCallbacks = []; // Callbacks to execute when config is loaded
    
    /**
     * Load configuration from backend using ICN Request API
     * Returns a Deferred that resolves when configuration is loaded
     */
    function loadConfiguration() {
        if (configLoaded) {
            console.log("[CNBPropertyEditorEDSPlugin] Configuration already loaded, returning cached config");
            var d = new Deferred();
            d.resolve(editorConfig);
            return d;
        }
        
        if (configLoading && configLoadDeferred) {
            console.log("[CNBPropertyEditorEDSPlugin] Configuration already loading, returning existing deferred");
            return configLoadDeferred;
        }
        
        configLoading = true;
        configLoadDeferred = new Deferred();
        
        console.log("[CNBPropertyEditorEDSPlugin] Loading configuration from backend...");
        
        // Use ICN's Request.invokePluginService()
        Request.invokePluginService("CNBPropertyEditorEDSPlugin", "GetLookupConfigService", {
            requestParams: {},
            requestCompleteCallback: function(response) {
                console.log("[CNBPropertyEditorEDSPlugin] Service response:", response);
                
                editorConfig = response.documentClasses || {};
                configLoaded = true;
                configLoading = false;
                
                var classCount = Object.keys(editorConfig).length;
                console.log("[CNBPropertyEditorEDSPlugin] ✓ Configuration loaded successfully");
                console.log("[CNBPropertyEditorEDSPlugin] ✓ Loaded " + classCount + " document class(es):");
                
                for (var className in editorConfig) {
                    var propsCount = editorConfig[className].properties ? 
                                    Object.keys(editorConfig[className].properties).length : 0;
                    console.log("[CNBPropertyEditorEDSPlugin]   - " + className + " (" + propsCount + " properties)");
                }
                
                // Resolve the deferred
                if (configLoadDeferred) {
                    configLoadDeferred.resolve(editorConfig);
                }
                
                // Execute any waiting callbacks
                while (configLoadCallbacks.length > 0) {
                    var callback = configLoadCallbacks.shift();
                    try {
                        callback(editorConfig);
                    } catch (e) {
                        console.error("[CNBPropertyEditorEDSPlugin] Error in config load callback:", e);
                    }
                }
            },
            requestFailedCallback: function(error) {
                console.error("[CNBPropertyEditorEDSPlugin] ✗ Failed to load configuration:", error);
                editorConfig = {};
                configLoaded = true;
                configLoading = false;
                
                // Resolve the deferred even on failure (with empty config)
                if (configLoadDeferred) {
                    configLoadDeferred.resolve(editorConfig);
                }
                
                // Execute any waiting callbacks
                while (configLoadCallbacks.length > 0) {
                    var callback = configLoadCallbacks.shift();
                    try {
                        callback(editorConfig);
                    } catch (e) {
                        console.error("[CNBPropertyEditorEDSPlugin] Error in config load callback:", e);
                    }
                }
            }
        });
        
        return configLoadDeferred;
    }
    
    /**
     * Ensure configuration is loaded before executing callback
     * If config is already loaded, callback executes immediately
     * If config is loading, callback is queued and executes when loading completes
     */
    function ensureConfigLoaded(callback) {
        if (configLoaded) {
            callback(editorConfig);
        } else {
            configLoadCallbacks.push(callback);
            // Trigger load if not already loading
            if (!configLoading) {
                loadConfiguration();
            }
        }
    }
    
    /**
     * Initialize configuration loading when desktop is ready
     * This ensures the plugin service can be called successfully
     */
    function initializeOnDesktopReady() {
        console.log("[CNBPropertyEditorEDSPlugin] Setting up desktop ready listeners...");
        
        var configLoadAttempted = false;
        
        function attemptConfigLoad(source) {
            if (!configLoaded && !configLoading) {
                console.log("[CNBPropertyEditorEDSPlugin] Loading configuration triggered by: " + source);
                configLoadAttempted = true;
                loadConfiguration();
            } else if (configLoaded) {
                console.log("[CNBPropertyEditorEDSPlugin] Configuration already loaded (triggered by: " + source + ")");
            } else if (configLoading) {
                console.log("[CNBPropertyEditorEDSPlugin] Configuration already loading (triggered by: " + source + ")");
            }
        }
        
        // Method 1: Check if desktop is already logged in and has repositories
        if (desktop && desktop.id && desktop.repositories && desktop.repositories.length > 0) {
            console.log("[CNBPropertyEditorEDSPlugin] Desktop already fully loaded (id: " + desktop.id + 
                       ", repositories: " + desktop.repositories.length + ")");
            attemptConfigLoad("desktop already ready");
        }
        
        // Method 2: Listen for repository connection (most reliable)
        // This fires when a repository is connected after login
        topic.subscribe("/ecm/model/Repository/onConnected", function(repository) {
            console.log("[CNBPropertyEditorEDSPlugin] Repository connected: " + (repository ? repository.id : "unknown"));
            attemptConfigLoad("/ecm/model/Repository/onConnected");
        });
        
        // Method 3: Listen for desktop login event
        if (desktop && desktop.onLogin) {
            aspect.after(desktop, "onLogin", function() {
                console.log("[CNBPropertyEditorEDSPlugin] desktop.onLogin triggered");
                // Small delay to ensure session is fully established
                setTimeout(function() {
                    attemptConfigLoad("desktop.onLogin aspect");
                }, 100);
            }, true);
        }
        
        // Method 4: Subscribe to various ICN topics
        var icnTopics = [
            "/ecm/desktop/onLogin",
            "/ecm/desktop/onDesktopLoaded", 
            "/ecm/widget/layout/onLayoutCreated"
        ];
        
        icnTopics.forEach(function(topicName) {
            topic.subscribe(topicName, function() {
                console.log("[CNBPropertyEditorEDSPlugin] Received topic: " + topicName);
                attemptConfigLoad(topicName);
            });
        });
        
        // Method 5: Fallback with multiple retry attempts
        var retryDelays = [500, 1000, 2000, 3000];
        retryDelays.forEach(function(delay) {
            setTimeout(function() {
                if (!configLoaded && !configLoading) {
                    console.log("[CNBPropertyEditorEDSPlugin] Fallback retry after " + delay + "ms...");
                    attemptConfigLoad("fallback timeout " + delay + "ms");
                }
            }, delay);
        });
        
        // Method 6: Try immediate load in case desktop is ready
        // This handles page refresh scenarios
        setTimeout(function() {
            if (!configLoadAttempted && !configLoading && !configLoaded) {
                console.log("[CNBPropertyEditorEDSPlugin] Attempting immediate configuration load...");
                attemptConfigLoad("immediate attempt");
            }
        }, 0);
    }
    
    // Initialize configuration loading with desktop ready detection
    initializeOnDesktopReady();
    
    // ========================================================================
    // PROPERTY DISPLAY ORDER: Intercept CommonPropertiesPane.renderAttributes
    // to reorder properties according to configuration
    // ========================================================================
    require(["ecm/widget/CommonPropertiesPane"], function(CommonPropertiesPane) {
        try {
            console.log("[CNBPropertyEditorEDSPlugin] Setting up property display order interception...");
            
            aspect.around(CommonPropertiesPane.prototype, "renderAttributes", function(original) {
                return function(attributeDefinitions, item, reason, isReadOnly, params) {
                    console.log("[CNBPropertyEditorEDSPlugin] ========================================");
                    console.log("[CNBPropertyEditorEDSPlugin] >>> Intercepting renderAttributes");
                    console.log("[CNBPropertyEditorEDSPlugin] Reason:", reason);
                    console.log("[CNBPropertyEditorEDSPlugin] Number of properties:", attributeDefinitions ? attributeDefinitions.length : 0);
                    console.log("[CNBPropertyEditorEDSPlugin] Item:", item ? "present" : "null");
                    console.log("[CNBPropertyEditorEDSPlugin] isReadOnly:", isReadOnly);
                    console.log("[CNBPropertyEditorEDSPlugin] params:", params ? "present" : "null/undefined");
                    if (params) {
                        console.log("[CNBPropertyEditorEDSPlugin] params.entryTemplate:", params.entryTemplate ? params.entryTemplate.name : "not present");
                    }
                    
                    // If item is not null (editing existing document), remove propertyEditor and Record_Lookup
                    if (item != null && attributeDefinitions && attributeDefinitions.length > 0) {
                        console.log("[CNBPropertyEditorEDSPlugin] Item is not null - removing propertyEditor from all attributes");
                        var removedCount = 0;
                        
                        for (var i = 0; i < attributeDefinitions.length; i++) {
                            var attr = attributeDefinitions[i];
                            if (attr && attr.propertyEditor) {
                                console.log("[CNBPropertyEditorEDSPlugin]   ✗ Removing propertyEditor from: " + (attr.id || attr.name));
                                delete attr.propertyEditor;
                                removedCount++;
                            }
                        }
                        
                        console.log("[CNBPropertyEditorEDSPlugin] ✓ Removed propertyEditor from " + removedCount + " attribute(s)");
                        
                        // Remove Record_Lookup attribute definition
                        var recordLookupIndex = -1;
                        for (var j = 0; j < attributeDefinitions.length; j++) {
                            var attrDef = attributeDefinitions[j];
                            var attrName = attrDef ? (attrDef.id || attrDef.name) : null;
                            if (attrName === "Record_Lookup") {
                                recordLookupIndex = j;
                                break;
                            }
                        }
                        
                        if (recordLookupIndex !== -1) {
                            console.log("[CNBPropertyEditorEDSPlugin]   ✗ Removing Record_Lookup attribute definition from array");
                            attributeDefinitions.splice(recordLookupIndex, 1);
                            console.log("[CNBPropertyEditorEDSPlugin] ✓ Removed Record_Lookup attribute definition");
                            console.log("[CNBPropertyEditorEDSPlugin]   Remaining properties: " + attributeDefinitions.length);
                        } else {
                            console.log("[CNBPropertyEditorEDSPlugin]   Record_Lookup attribute definition not found");
                        }
                    }
                    
                    // Check configuration loading status
                    if (!configLoaded) {
                        console.log("[CNBPropertyEditorEDSPlugin] ⚠ Configuration not yet loaded - triggering load...");
                        // Trigger configuration load if not already loading
                        if (!configLoading) {
                            loadConfiguration();
                        }
                        console.log("[CNBPropertyEditorEDSPlugin] ⚠ Entry template configurations will not be applied on this render");
                        console.log("[CNBPropertyEditorEDSPlugin] ⚠ User may need to refresh or re-open the dialog");
                    }
                    
                    // Only apply entry template-specific configurations for document creation
                    if (configLoaded && editorConfig && attributeDefinitions && attributeDefinitions.length > 0 && item == null) {
                        try {
                            // Get document class name
                            var documentClass = null;
                            
                            if (attributeDefinitions[0] && attributeDefinitions[0].contentClass) {
                                documentClass = attributeDefinitions[0].contentClass.id;
                            } else if (item && item.contentClass) {
                                documentClass = item.contentClass.name;
                            }
                            
                            console.log("[CNBPropertyEditorEDSPlugin] Document class:", documentClass);
                            
                            // Get entry template - try multiple sources
                            var entryTemplate = null;
                            var entryTemplateName = null;
                            
                            // Source 1: From params.entryTemplate (standard OOTB flow)
                            if (params && params.entryTemplate) {
                                entryTemplate = params.entryTemplate;
                                entryTemplateName = params.entryTemplate.name;
                                console.log("[CNBPropertyEditorEDSPlugin] Entry template from params:", entryTemplateName);
                            }
                            
                            // Source 2: From parent widget chain - find AddContentItemDialog's _entryTemplate
                            // This is the fallback for custom dialogs that might not pass params.entryTemplate properly
                            if (!entryTemplateName) {
                                console.log("[CNBPropertyEditorEDSPlugin] Entry template not in params, searching widget hierarchy...");
                                
                                // 'this' is the CommonPropertiesPane instance
                                // Try to find the dialog through the widget hierarchy
                                var widget = this;
                                var maxDepth = 10; // Prevent infinite loops
                                var depth = 0;
                                
                                while (widget && depth < maxDepth) {
                                    // Check if this widget has _addContentItemDialog reference
                                    if (widget._addContentItemDialog && widget._addContentItemDialog._entryTemplate) {
                                        entryTemplate = widget._addContentItemDialog._entryTemplate;
                                        entryTemplateName = entryTemplate.name;
                                        console.log("[CNBPropertyEditorEDSPlugin] ✓ Found entry template from _addContentItemDialog:", entryTemplateName);
                                        break;
                                    }
                                    
                                    // Check if this widget IS the dialog (has _entryTemplate directly)
                                    if (widget._entryTemplate) {
                                        entryTemplate = widget._entryTemplate;
                                        entryTemplateName = entryTemplate.name;
                                        console.log("[CNBPropertyEditorEDSPlugin] ✓ Found entry template from widget._entryTemplate:", entryTemplateName);
                                        break;
                                    }
                                    
                                    // Try to get parent widget
                                    if (widget.getParent && typeof widget.getParent === 'function') {
                                        widget = widget.getParent();
                                    } else if (widget.domNode && widget.domNode.parentNode) {
                                        // Try to find parent via dijit.registry
                                        var parentNode = widget.domNode.parentNode;
                                        widget = null;
                                        while (parentNode && !widget) {
                                            if (parentNode.id) {
                                                try {
                                                    var dijit = require("dijit/registry");
                                                    widget = dijit.byId(parentNode.id);
                                                } catch (e) {
                                                    // Ignore errors
                                                }
                                            }
                                            parentNode = parentNode.parentNode;
                                        }
                                    } else {
                                        break;
                                    }
                                    depth++;
                                }
                                
                                if (!entryTemplateName) {
                                    console.log("[CNBPropertyEditorEDSPlugin] Entry template not found in widget hierarchy (searched " + depth + " levels)");
                                }
                            }
                            
                            // Source 3: Try to get from ecm.model.desktop's current context
                            if (!entryTemplateName) {
                                try {
                                    var desktop = require("ecm/model/Desktop");
                                    if (desktop && desktop.addContentItemDialog && desktop.addContentItemDialog._entryTemplate) {
                                        entryTemplate = desktop.addContentItemDialog._entryTemplate;
                                        entryTemplateName = entryTemplate.name;
                                        console.log("[CNBPropertyEditorEDSPlugin] ✓ Found entry template from desktop.addContentItemDialog:", entryTemplateName);
                                    }
                                } catch (e) {
                                    // Ignore - desktop might not have this reference
                                }
                            }
                            
                            // Log final status
                            if (entryTemplateName) {
                                console.log("[CNBPropertyEditorEDSPlugin] Entry template name:", entryTemplateName);
                                if (entryTemplate && entryTemplate.propertiesOptions) {
                                    console.log("[CNBPropertyEditorEDSPlugin] Entry template has propertiesOptions:", entryTemplate.propertiesOptions.length + " items");
                                }
                            } else {
                                console.log("[CNBPropertyEditorEDSPlugin] No entry template found from any source");
                            }
                            
                            // Get configuration - check for entry template-specific config first
                            var entryTemplateConfig = null;
                            if (documentClass && editorConfig[documentClass]) {
                                var classConfig = editorConfig[documentClass];
                                
                                // If entry template name is available, try to get entry template-specific config
                                if (entryTemplateName && classConfig[entryTemplateName]) {
                                    entryTemplateConfig = classConfig[entryTemplateName];
                                    console.log("[CNBPropertyEditorEDSPlugin] ✓ Found entry template-specific configuration for: " + entryTemplateName);
                                } else {
                                    // Fallback: check if classConfig has direct properties (backward compatibility)
                                    if (classConfig.propertyDisplayOrder || classConfig.showProperties || 
                                        classConfig.customLabelsAndDesc || classConfig.requiredProperties) {
                                        entryTemplateConfig = classConfig;
                                        console.log("[CNBPropertyEditorEDSPlugin] ✓ Using document class-level configuration (backward compatibility)");
                                    }
                                }
                            }
                            
                            if (entryTemplateConfig) {
                                // STEP 1: Filter properties based on showProperties
                                if (entryTemplateConfig.showProperties && entryTemplateConfig.showProperties.length > 0) {
                                    console.log("[CNBPropertyEditorEDSPlugin] ✓ showProperties configured:", entryTemplateConfig.showProperties);
                                    
                                    var visibleAttributes = [];
                                    
                                    attributeDefinitions.forEach(function(attr) {
                                        var propertyName = attr.id || attr.name;
                                        
                                        // Check if this property should be visible
                                        var shouldVisible = entryTemplateConfig.showProperties.indexOf(propertyName) !== -1;
                                        
                                        if (!shouldVisible) {
                                            attr.hidden = true;
                                        }
                                    });
                                    
                                    console.log("[CNBPropertyEditorEDSPlugin] ✓ Properties filtered successfully");
                                    console.log("[CNBPropertyEditorEDSPlugin]   Before filtering: " + attributeDefinitions.length + " properties");
                                    console.log("[CNBPropertyEditorEDSPlugin]   After filtering: " + visibleAttributes.length + " properties");
                                    
                                    // Replace attributeDefinitions with filtered version
                                    //attributeDefinitions = visibleAttributes;
                                }
                                
                                // STEP 2: Apply custom labels and descriptions
                                if (entryTemplateConfig.customLabelsAndDesc) {
                                    var labels = entryTemplateConfig.customLabelsAndDesc.labels;
                                    var desc = entryTemplateConfig.customLabelsAndDesc.desc;
                                    
                                    if (labels || desc) {
                                        console.log("[CNBPropertyEditorEDSPlugin] ✓ Custom labels/descriptions configured");
                                        
                                        attributeDefinitions.forEach(function(attr) {
                                            var propertyName = attr.id || attr.name;
                                            
                                            // ICN uses attributeDefinition.name for the label display (not attributeDefinition.label)
                                            // See CommonPropertiesPane.js line 312: attributeDefinition.name
                                            if (labels && labels[propertyName]) {
                                                attr.name = labels[propertyName];
                                                console.log("[CNBPropertyEditorEDSPlugin]   ✓ Updated name (label) for '" + propertyName + "': " + labels[propertyName]);
                                            }
                                            
                                            if (desc && desc[propertyName]) {
                                                attr.description = desc[propertyName];
                                                console.log("[CNBPropertyEditorEDSPlugin]   ✓ Updated description for '" + propertyName + "': " + desc[propertyName]);
                                            }
                                        });
                                    }
                                }
                                
                                // STEP 3: Reorder properties based on propertyDisplayOrder
                                if (entryTemplateConfig.propertyDisplayOrder && entryTemplateConfig.propertyDisplayOrder.length > 0) {
                                    console.log("[CNBPropertyEditorEDSPlugin] ✓ Property display order configured:", entryTemplateConfig.propertyDisplayOrder);
                                    
                                    // Reorder attributeDefinitions based on propertyDisplayOrder
                                    var orderedAttributes = [];
                                    var remainingAttributes = [].concat(attributeDefinitions); // Clone array
                                    
                                    // First, add properties in the specified order
                                    entryTemplateConfig.propertyDisplayOrder.forEach(function(propertyName) {
                                        for (var i = 0; i < remainingAttributes.length; i++) {
                                            var attr = remainingAttributes[i];
                                            if (attr.id === propertyName || attr.name === propertyName) {
                                                orderedAttributes.push(attr);
                                                remainingAttributes.splice(i, 1);
                                                console.log("[CNBPropertyEditorEDSPlugin]   ✓ Ordered property:", propertyName);
                                                break;
                                            }
                                        }
                                    });
                                    
                                    // Then, add any remaining properties not in the display order (at the end)
                                    remainingAttributes.forEach(function(attr) {
                                        orderedAttributes.push(attr);
                                        console.log("[CNBPropertyEditorEDSPlugin]   + Added remaining property:", attr.id || attr.name);
                                    });
                                    
                                    console.log("[CNBPropertyEditorEDSPlugin] ✓ Properties reordered successfully");
                                    console.log("[CNBPropertyEditorEDSPlugin]   Original order: " + 
                                               attributeDefinitions.map(function(a) { return a.id || a.name; }).join(", "));
                                    console.log("[CNBPropertyEditorEDSPlugin]   New order: " + 
                                               orderedAttributes.map(function(a) { return a.id || a.name; }).join(", "));
                                    
                                    // Replace attributeDefinitions with ordered version
                                    attributeDefinitions = orderedAttributes;
                                }
                                
                                // STEP 4: Apply required properties
                                if (entryTemplateConfig.requiredProperties && entryTemplateConfig.requiredProperties.length > 0) {
                                    console.log("[CNBPropertyEditorEDSPlugin] ✓ requiredProperties configured:", entryTemplateConfig.requiredProperties);
                                    
                                    attributeDefinitions.forEach(function(attr) {
                                        var propertyName = attr.id || attr.name;
                                        var isRequired = entryTemplateConfig.requiredProperties.indexOf(propertyName) !== -1;
                                        
                                        // Set required attribute based on configuration
                                        attr.required = isRequired;
                                        
                                        if (isRequired) {
                                            console.log("[CNBPropertyEditorEDSPlugin]   ✓ Set required=true for: " + propertyName);
                                        } else {
                                            // Only log if it was previously required (to show we're clearing it)
                                            if (attr.required === true) {
                                                console.log("[CNBPropertyEditorEDSPlugin]   ✓ Set required=false for: " + propertyName + " (was previously required)");
                                            }
                                        }
                                    });
                                }
                                
                                // STEP 5: Apply default values
                                if (entryTemplateConfig.defaultValues) {
                                    console.log("[CNBPropertyEditorEDSPlugin] ✓ defaultValues configured:", entryTemplateConfig.defaultValues);
                                    
                                    attributeDefinitions.forEach(function(attr) {
                                        var propertyName = attr.id || attr.name;
                                        
                                        if (entryTemplateConfig.defaultValues.hasOwnProperty(propertyName)) {
                                            var defaultValue = entryTemplateConfig.defaultValues[propertyName];
                                            
                                            // Set default value on attribute definition
                                            // ICN uses defaultValue for initial form values
                                            attr.defaultValue = defaultValue;
                                            
                                            console.log("[CNBPropertyEditorEDSPlugin]   ✓ Set defaultValue for '" + propertyName + "': " + defaultValue);
                                        }
                                    });
                                }
                                
                                // STEP 6: Apply readonly properties
                                if (entryTemplateConfig.readOnlyProperties && entryTemplateConfig.readOnlyProperties.length > 0) {
                                    console.log("[CNBPropertyEditorEDSPlugin] ✓ readOnlyProperties configured:", entryTemplateConfig.readOnlyProperties);
                                    
                                    attributeDefinitions.forEach(function(attr) {
                                        var propertyName = attr.id || attr.name;
                                        var isReadOnly = entryTemplateConfig.readOnlyProperties.indexOf(propertyName) !== -1;
                                        
                                        // Set readonly attribute based on configuration
                                        // ICN uses readOnly property to make fields non-editable
                                        attr.readOnly = isReadOnly;
                                        
                                        if (isReadOnly) {
                                            console.log("[CNBPropertyEditorEDSPlugin]   ✓ Set readOnly=true for: " + propertyName);
                                        } else {
                                            // Only log if it was previously readonly (to show we're clearing it)
                                            if (attr.readOnly === true) {
                                                console.log("[CNBPropertyEditorEDSPlugin]   ✓ Set readOnly=false for: " + propertyName + " (was previously readonly)");
                                            }
                                        }
                                    });
                                }
                            } else {
                                // No custom plugin configuration found
                                // Check if we should apply the entry template's OOTB propertiesOptions
                                if (documentClass && !editorConfig[documentClass]) {
                                    console.log("[CNBPropertyEditorEDSPlugin]   No configuration found for document class: " + documentClass);
                                } else if (entryTemplateName && documentClass && editorConfig[documentClass] && !editorConfig[documentClass][entryTemplateName]) {
                                    console.log("[CNBPropertyEditorEDSPlugin]   No entry template-specific configuration found for: " + entryTemplateName);
                                }
                                
                                // FALLBACK: Apply entry template's built-in propertiesOptions if available
                                // This ensures OOTB entry template customizations (ordering, labels, hidden, readonly, etc.)
                                // are applied even when no custom plugin configuration exists
                                if (entryTemplate && entryTemplate.propertiesOptions && entryTemplate.propertiesOptions.length > 0) {
                                    console.log("[CNBPropertyEditorEDSPlugin] ========================================");
                                    console.log("[CNBPropertyEditorEDSPlugin] Applying entry template's OOTB propertiesOptions...");
                                    console.log("[CNBPropertyEditorEDSPlugin] Entry template: " + entryTemplateName);
                                    console.log("[CNBPropertyEditorEDSPlugin] propertiesOptions count: " + entryTemplate.propertiesOptions.length);
                                    
                                    // Create a map of propertiesOptions by property id for quick lookup
                                    var propsOptionsMap = {};
                                    entryTemplate.propertiesOptions.forEach(function(opt) {
                                        if (opt && opt.id) {
                                            propsOptionsMap[opt.id] = opt;
                                        }
                                    });
                                    
                                    // Build ordered list and apply property options
                                    var orderedAttrs = [];
                                    var attrMap = {};
                                    
                                    // Create a map of existing attributes
                                    attributeDefinitions.forEach(function(attr) {
                                        if (attr && attr.id) {
                                            attrMap[attr.id] = attr;
                                        }
                                    });
                                    
                                    // First, add properties in the order defined by propertiesOptions
                                    entryTemplate.propertiesOptions.forEach(function(propOpt) {
                                        var attr = attrMap[propOpt.id];
                                        if (attr) {
                                            // Apply entry template property options
                                            if (propOpt.hidden === true) {
                                                attr.hidden = true;
                                                console.log("[CNBPropertyEditorEDSPlugin]   ✓ Set hidden=true for: " + propOpt.id);
                                            }
                                            if (propOpt.readOnly === true) {
                                                attr.readOnly = true;
                                                console.log("[CNBPropertyEditorEDSPlugin]   ✓ Set readOnly=true for: " + propOpt.id);
                                            }
                                            if (propOpt.required === true) {
                                                attr.required = true;
                                                console.log("[CNBPropertyEditorEDSPlugin]   ✓ Set required=true for: " + propOpt.id);
                                            }
                                            if (propOpt.defaultValue !== undefined && propOpt.defaultValue !== null) {
                                                attr.defaultValue = propOpt.defaultValue;
                                                console.log("[CNBPropertyEditorEDSPlugin]   ✓ Set defaultValue for " + propOpt.id + ": " + propOpt.defaultValue);
                                            }
                                            // Apply custom label if available
                                            if (propOpt.label) {
                                                attr.name = propOpt.label;
                                                console.log("[CNBPropertyEditorEDSPlugin]   ✓ Set custom label for " + propOpt.id + ": " + propOpt.label);
                                            }
                                            
                                            orderedAttrs.push(attr);
                                            delete attrMap[propOpt.id]; // Remove from map
                                        }
                                    });
                                    
                                    // Add remaining attributes that weren't in propertiesOptions
                                    for (var attrId in attrMap) {
                                        if (attrMap.hasOwnProperty(attrId)) {
                                            orderedAttrs.push(attrMap[attrId]);
                                            console.log("[CNBPropertyEditorEDSPlugin]   + Added remaining property: " + attrId);
                                        }
                                    }
                                    
                                    // Replace attributeDefinitions with ordered version
                                    if (orderedAttrs.length > 0) {
                                        attributeDefinitions = orderedAttrs;
                                        console.log("[CNBPropertyEditorEDSPlugin] ✓ Applied entry template propertiesOptions successfully");
                                        console.log("[CNBPropertyEditorEDSPlugin]   Total properties: " + attributeDefinitions.length);
                                    }
                                }
                            }
                        } catch (e) {
                            console.error("[CNBPropertyEditorEDSPlugin] Error applying entry template configurations:", e);
                        }
                    }
                    
                    // Call original renderAttributes with (possibly modified) attributeDefinitions
                    return original.call(this, attributeDefinitions, item, reason, isReadOnly, params);
                };
            });
            
            console.log("[CNBPropertyEditorEDSPlugin] ✓ Property display order interception set up successfully");
            
        } catch (e) {
            console.error("[CNBPropertyEditorEDSPlugin] Failed to set up property display order:", e);
        }
    });
    
    console.log("[CNBPropertyEditorEDSPlugin] Plugin initialized successfully");
    console.log("[CNBPropertyEditorEDSPlugin] ====================================");
});
