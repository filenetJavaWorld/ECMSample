define([
	"dojo/_base/declare",
	"dojo/_base/lang",
	"dojo/on",
	"dijit/form/Button",
	"dijit/layout/BorderContainer",
	"dijit/layout/ContentPane",
	"ecm/widget/layout/_LaunchBarPane",
	"ecm/model/Desktop",
	"./DocumentUploadDialog",
	"dojo/text!./templates/DocumentUploadFeature.html"
],
function(declare, lang, on, Button, BorderContainer, ContentPane, _LaunchBarPane, Desktop, DocumentUploadDialog, template) {
	/**
	 * @name mutiRepoSearchPluginDojo.DocumentUploadFeature
	 * @class Document Upload Feature with Entry Template and Reference Viewer
	 * @augments ecm.widget.layout._LaunchBarPane
	 */
	return declare("mutiRepoSearchPluginDojo.DocumentUploadFeature", [
		_LaunchBarPane
	], {
		/** @lends mutiRepoSearchPluginDojo.DocumentUploadFeature.prototype */

		templateString: template,
		
		// Set to true if widget template contains DOJO widgets.
		widgetsInTemplate: true,
		
		// Dialog reference
		_uploadDialog: null,
		
		// Hardcoded document GUID for testing - replace with actual GUID from your repository
		_referenceDocumentGuid: "{795EA3F5-C370-4A4D-AC5F-AEBCFF693055}",

		postCreate: function() {
			this.logEntry("postCreate");
			this.inherited(arguments);
			
			// Connect button click event
			if (this.uploadButton) {
				on(this.uploadButton, "click", lang.hitch(this, "_onUploadButtonClick"));
			}
			
			this.logExit("postCreate");
		},
		
		/**
		 * Handle upload button click
		 * Mimics CommonActionsHandler.actionImportUsingTemplate
		 */
		_onUploadButtonClick: function() {
			this.logEntry("_onUploadButtonClick");
			
			// Get the current repository from desktop
			var repository = ecm.model.desktop.getDefaultRepository();
			
			if (!repository) {
				console.error("No repository available");
				alert("Please ensure you are connected to a repository.");
				return;
			}
			
			// Ensure repository is connected
			if (!repository.connected) {
				repository.logon(null, lang.hitch(this, function() {
					this._showUploadDialog(repository);
				}));
			} else {
				this._showUploadDialog(repository);
			}
			
			this.logExit("_onUploadButtonClick");
		},
		
		/**
		 * Show the upload dialog with reference document viewer
		 * This mimics how CommonActionsHandler.actionImportUsingTemplate works
		 */
		_showUploadDialog: function(repository) {
			this.logEntry("_showUploadDialog");
			
			// Destroy existing dialog if any (similar to CommonActionsHandler pattern)
			if (this._uploadDialog) {
				this._uploadDialog.destroyRecursive();
			}
			
			// Create our extended AddContentItemDialog
			this._uploadDialog = new DocumentUploadDialog();
			
			// Set the reference document GUID before showing the dialog
			this._uploadDialog.setReferenceDocument(this._referenceDocumentGuid);
			
			// Get parent folder if needed (null for now, can be set based on selection)
			var parentFolder = null;
			
			// Define callback for when document is added
			var callback = lang.hitch(this, function(addedItems) {
				console.log("Document(s) added successfully:", addedItems);
				// Add any post-add logic here (e.g., refresh a list)
			});
			
			// Call showUsingTemplateItem - this is exactly how CommonActionsHandler does it
			// Parameters: repository, parentFolder, typeDocument, virtualItems, callback, teamspace, selectedItem
			this._uploadDialog.showUsingTemplateItem(
				repository,     // repository
				parentFolder,   // parentFolder
				true,           // typeDocument (true = document, false = folder)
				false,          // virtualItems
				callback,       // callback
				null,           // teamspace
				null            // selectedItem (entry template item, null = let user choose)
			);
			
			this.logExit("_showUploadDialog");
		},
		
		/**
		 * Alternative method to show dialog with a specific entry template
		 */
		_showUploadDialogWithTemplate: function(repository, entryTemplateItem) {
			this.logEntry("_showUploadDialogWithTemplate");
			
			if (this._uploadDialog) {
				this._uploadDialog.destroyRecursive();
			}
			
			this._uploadDialog = new DocumentUploadDialog();
			this._uploadDialog.setReferenceDocument(this._referenceDocumentGuid);
			
			var callback = lang.hitch(this, function(addedItems) {
				console.log("Document(s) added successfully:", addedItems);
			});
			
			// If entry template item is provided, pass it as selectedItem
			this._uploadDialog.showUsingTemplateItem(
				repository,
				null,               // parentFolder
				true,               // typeDocument
				false,              // virtualItems
				callback,           // callback
				null,               // teamspace
				entryTemplateItem   // selectedItem - the entry template to use
			);
			
			this.logExit("_showUploadDialogWithTemplate");
		},
		
		/**
		 * Optional method that sets additional parameters when the user clicks on the launch button
		 */
		setParams: function(params) {
			this.logEntry("setParams", params);
			
			if (params) {
				// You can receive the reference document GUID from params
				if (params.referenceDocumentGuid) {
					this._referenceDocumentGuid = params.referenceDocumentGuid;
				}
				
				if (!this.isLoaded && this.selected) {
					this.loadContent();
				}
			}
			
			this.logExit("setParams");
		},

		/**
		 * Loads the content of the pane.
		 */
		loadContent: function() {
			this.logEntry("loadContent");
			
			if (!this.isLoaded) {
				this.isLoaded = true;
				this.needReset = false;
			}
			
			this.logExit("loadContent");
		},

		/**
		 * Resets the content of this pane.
		 */
		reset: function() {
			this.logEntry("reset");
			this.needReset = false;
			this.logExit("reset");
		},
		
		/**
		 * Cleanup on destroy
		 */
		destroy: function() {
			if (this._uploadDialog) {
				this._uploadDialog.destroyRecursive();
				this._uploadDialog = null;
			}
			this.inherited(arguments);
		}
	});
});


<div class="ecmCenterPane documentUploadFeature">
	<div data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="gutters:true" style="width: 100%; height: 100%;">
		
		<!-- Top Toolbar -->
		<div data-dojo-type="dijit/layout/ContentPane" 
			 data-dojo-props="region:'top'" 
			 style="padding: 10px; background: #f5f5f5; border-bottom: 1px solid #ddd;">
			
			<h3 style="margin: 0 0 10px 0;">Document Upload Feature</h3>
			
			<button data-dojo-type="dijit/form/Button" 
					data-dojo-attach-point="uploadButton"
					data-dojo-props="iconClass: 'dijitIconNewTask', label: 'Add Document Using Entry Template'">
			</button>
			
		</div>
		
		<!-- Center Content Area -->
		<div data-dojo-type="dijit/layout/ContentPane" 
			 data-dojo-props="region:'center'" 
			 style="padding: 20px;">
			
			<p>Click the button above to open the Add Document dialog with a reference document viewer.</p>
			<p>The dialog will display:</p>
			<ul>
				<li><strong>Left Panel:</strong> Entry Template selection and document properties</li>
				<li><strong>Right Panel:</strong> Reference document viewer (read-only)</li>
			</ul>
			
		</div>
		
	</div>
</div>


define([
	"dojo/_base/declare",
	"dojo/_base/lang",
	"dojo/dom-style",
	"dojo/aspect",
	"dijit/layout/BorderContainer",
	"dijit/layout/ContentPane",
	"idx/layout/TitlePane",
	"ecm/widget/dialog/AddContentItemDialog",
	"ecm/widget/AddContentItemGeneralPane",
	"ecm/widget/AddContentItemPropertiesPane",
	"ecm/widget/AddContentItemSecurityPane",
	"ecm/widget/viewer/ContentViewerPane",
	"ecm/widget/viewer/model/ViewerItem",
	"ecm/model/Desktop",
	"ecm/Messages",
	"dojo/text!./templates/DocumentUploadDialog.html"
], function(declare, lang, domStyle, aspect, BorderContainer, ContentPane, TitlePane, 
	AddContentItemDialog, AddContentItemGeneralPane, AddContentItemPropertiesPane, 
	AddContentItemSecurityPane, ContentViewerPane, ViewerItem, Desktop, Messages, template) {

	/**
	 * @name mutiRepoSearchPluginDojo.DocumentUploadDialog
	 * @class Extended AddContentItemDialog with embedded document viewer
	 * @augments ecm.widget.dialog.AddContentItemDialog
	 */
	return declare("mutiRepoSearchPluginDojo.DocumentUploadDialog", [
		AddContentItemDialog
	], {
		/** @lends mutiRepoSearchPluginDojo.DocumentUploadDialog.prototype */
		
		// Override the template with our custom one that includes viewer
		contentString: template,
		widgetsInTemplate: true,
		
		// Document GUID to display in viewer
		documentGuid: null,
		
		// Content viewer pane reference
		_contentViewerPane: null,
		
		// Reference to the retrieved content item for viewing
		_referenceContentItem: null,

		postCreate: function() {
			this.inherited(arguments);
			// Additional setup after parent's postCreate
			console.log("DocumentUploadDialog: postCreate completed");
		},

		/**
		 * Override show to also load the reference document in viewer
		 * All parameters are passed to parent's show method
		 */
		show: function(repository, parentFolder, typeDocument, virtualItems, callback, teamspace, useTemplate, entryTemplate, showMultiRepoFolderSelector, repositoryTypes) {
			console.log("DocumentUploadDialog: show called");
			
			// Call parent's show method - this handles all OOTB functionality
			var result = this.inherited(arguments);
			
			// Load the reference document in our viewer pane
			if (this.documentGuid && repository) {
				this._loadReferenceDocument(repository);
			}
			
			return result;
		},

		/**
		 * Override showUsingTemplateItem to also load reference document
		 */
		showUsingTemplateItem: function(repository, parentFolder, typeDocument, virtualItems, callback, teamspace, selectedItem) {
			console.log("DocumentUploadDialog: showUsingTemplateItem called");
			
			// Call parent's showUsingTemplateItem - this handles all OOTB functionality
			this.inherited(arguments);
			
			// Load the reference document in our viewer pane
			if (this.documentGuid && repository) {
				this._loadReferenceDocument(repository);
			}
		},

		/**
		 * Set the document GUID to display in the viewer
		 * Call this before calling show() or showUsingTemplateItem()
		 */
		setReferenceDocument: function(documentGuid) {
			this.documentGuid = documentGuid;
		},

		/**
		 * Load and display the reference document in the viewer
		 */
		_loadReferenceDocument: function(repository) {
			var methodName = "_loadReferenceDocument";
			console.log(methodName + ": Loading document with GUID: " + this.documentGuid);
			
			if (!this.documentGuid) {
				console.log(methodName + ": No document GUID provided");
				if (this.viewerPane) {
					this.viewerPane.set("content", "<p style='padding:20px;'>No reference document specified.</p>");
				}
				return;
			}
			
			// Show loading message
			if (this.viewerPane) {
				this.viewerPane.set("content", "<p style='padding:20px;'>Loading reference document...</p>");
			}
			
			// Retrieve the document from repository
			repository.retrieveItem(this.documentGuid, lang.hitch(this, function(contentItem) {
				console.log(methodName + ": Document retrieved: " + contentItem.name);
				this._referenceContentItem = contentItem;
				
				// Create viewer item
				var viewerItem = new ViewerItem(contentItem);
				
				// Destroy existing viewer if any
				if (this._contentViewerPane) {
					this._contentViewerPane.destroyRecursive();
					this._contentViewerPane = null;
				}
				
				// Create content viewer pane
				this._contentViewerPane = new ContentViewerPane({
					style: "width: 100%; height: 100%;",
					preview: true  // Read-only preview mode
				});
				
				// Add viewer to viewer pane
				if (this.viewerPane) {
					this.viewerPane.set("content", this._contentViewerPane);
					
					// Open the document in viewer
					this._contentViewerPane.openItem(viewerItem, 1);
					
					// Activate the viewer after a short delay to ensure DOM is ready
					setTimeout(lang.hitch(this, function() {
						if (this._contentViewerPane) {
							this._contentViewerPane.activateViewer();
							this._contentViewerPane.resize();
						}
					}), 500);
				}
				
			}), lang.hitch(this, function(error) {
				console.error(methodName + ": Error retrieving document: ", error);
				if (this.viewerPane) {
					this.viewerPane.set("content", "<p style='padding:20px;color:red;'>Error loading reference document.</p>");
				}
			}));
		},

		/**
		 * Get the reference content item
		 */
		getReferenceContentItem: function() {
			return this._referenceContentItem;
		},

		/**
		 * Override resize to also resize the viewer
		 */
		resize: function() {
			this.inherited(arguments);
			if (this._contentViewerPane) {
				this._contentViewerPane.resize();
			}
		},

		/**
		 * Cleanup on destroy
		 */
		destroy: function() {
			if (this._contentViewerPane) {
				this._contentViewerPane.destroyRecursive();
				this._contentViewerPane = null;
			}
			this.inherited(arguments);
		}
	});
});


<div data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="gutters: true, liveSplitters: true" 
	 class="ecmAddContentItemBorderContainer documentUploadDialogContainer" 
	 data-dojo-attach-point="ecmAddContentItemBorderContainer" style="width: 100%; height: 100%;">
	
	<!-- Left Pane: OOTB Add Content Item Panes (Entry Template, Properties, Security) -->
	<div data-dojo-type="dijit/layout/ContentPane" 
		 data-dojo-props="region: 'left', splitter: true"
		 data-dojo-attach-point="addContentItemTabContainer" 
		 style="width: 50%; padding: 0; overflow: auto;">
		
		<!-- General Pane - Entry Template and File Selection -->
		<div data-dojo-type="idx/layout/TitlePane" 
			 data-dojo-props="title: '${_messages.add_document_general_label}'" 
			 class="addContentItemGeneralTitlePane" 
			 data-dojo-attach-point="addContentItemGeneralTitlePane">
			<div data-dojo-attach-point="addContentItemGeneralPane"
				 data-dojo-type="ecm/widget/AddContentItemGeneralPane" 
				 tabindex="0" 
				 aria-label="${_messages.add_document_general_label}">
			</div>
		</div>
		
		<!-- Properties Pane -->
		<div data-dojo-type="idx/layout/TitlePane" 
			 data-dojo-props="title: '${_messages.add_document_properties_label}'"
			 class="addContentItemPropertiesTitlePane" 
			 data-dojo-attach-point="addContentItemPropertiesTitlePane">
			<div data-dojo-attach-point="addContentItemPropertiesPane"
				 data-dojo-type="ecm/widget/AddContentItemPropertiesPane" 
				 tabindex="0" 
				 aria-label="${_messages.add_document_properties_label}">
			</div>
		</div>
		
		<!-- Security Pane -->
		<div data-dojo-type="idx/layout/TitlePane" 
			 data-dojo-props="title: '${_messages.add_document_security_label}'"
			 class="addContentItemSecurityTitlePane" 
			 data-dojo-attach-point="addContentItemSecurityTitlePane">
			<div data-dojo-attach-point="addContentItemSecurityPane"
				 data-dojo-type="ecm/widget/AddContentItemSecurityPane" 
				 tabindex="0" 
				 aria-label="${_messages.add_document_security_label}">
			</div>
		</div>
		
	</div>
	
	<!-- Right Pane: Reference Document Viewer -->
	<div data-dojo-type="dijit/layout/ContentPane" 
		 data-dojo-props="region: 'center'"
		 data-dojo-attach-point="viewerPane"
		 class="documentViewerPane"
		 style="padding: 0; overflow: hidden; border-left: 1px solid #ccc;">
		<div style="padding: 20px; text-align: center;">
			<p>Reference Document Viewer</p>
			<p style="color: #666;">Document will be displayed here...</p>
		</div>
	</div>
	
</div>
