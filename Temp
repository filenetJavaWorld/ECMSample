require([
    "dojo/_base/declare",
         "dojo/_base/lang",
    "dojo/aspect",
    "ecm/model/Request",
    "cNBPropertyEditorEDSPluginDojo/InlineAutocompleteEditor"
], 
function(declare, lang, aspect, Request, InlineAutocompleteEditor) {
    
    console.log("[CNBPropertyEditorEDSPlugin] ====================================");
    console.log("[CNBPropertyEditorEDSPlugin] Initializing plugin...");
    
    var editorConfig = null;
    var configLoaded = false;
    var configLoading = false;
    
    /**
     * Load configuration from backend using ICN Request API
     */
    function loadConfiguration() {
        if (configLoaded || configLoading) {
            return;
        }
        
        configLoading = true;
        console.log("[CNBPropertyEditorEDSPlugin] Loading configuration from backend...");
        
        // Use ICN's Request.invokePluginService() - the correct way!
        Request.invokePluginService("CNBPropertyEditorEDSPlugin", "GetLookupConfigService", {
            requestParams: {},
            requestCompleteCallback: function(response) {
                console.log("[CNBPropertyEditorEDSPlugin] Service response:", response);
                
                editorConfig = response.documentClasses || {};
                configLoaded = true;
                configLoading = false;
                
                var classCount = Object.keys(editorConfig).length;
                console.log("[CNBPropertyEditorEDSPlugin] ✓ Configuration loaded successfully");
                console.log("[CNBPropertyEditorEDSPlugin] ✓ Loaded " + classCount + " document class(es):");
                
                for (var className in editorConfig) {
                    var propsCount = editorConfig[className].properties ? 
                                    Object.keys(editorConfig[className].properties).length : 0;
                    console.log("[CNBPropertyEditorEDSPlugin]   - " + className + " (" + propsCount + " properties)");
                }
            },
            requestFailedCallback: function(error) {
                console.error("[CNBPropertyEditorEDSPlugin] ✗ Failed to load configuration:", error);
                editorConfig = {};
                configLoaded = true;
                configLoading = false;
            }
        });
    }
    
    // Load configuration on plugin startup
    loadConfiguration();
    
    // ========================================================================
    // PROPERTY DISPLAY ORDER: Intercept CommonPropertiesPane.renderAttributes
    // to reorder properties according to configuration
    // ========================================================================
    require(["ecm/widget/CommonPropertiesPane"], function(CommonPropertiesPane) {
        try {
            console.log("[CNBPropertyEditorEDSPlugin] Setting up property display order interception...");
            
            aspect.around(CommonPropertiesPane.prototype, "renderAttributes", function(original) {
                return function(attributeDefinitions, item, reason, isReadOnly, params) {
                    console.log("[CNBPropertyEditorEDSPlugin] ========================================");
                    console.log("[CNBPropertyEditorEDSPlugin] >>> Intercepting renderAttributes");
                    console.log("[CNBPropertyEditorEDSPlugin] Reason:", reason);
                    console.log("[CNBPropertyEditorEDSPlugin] Number of properties:", attributeDefinitions ? attributeDefinitions.length : 0);
                    
                    // Only reorder for document creation
                    if (configLoaded && editorConfig && attributeDefinitions && attributeDefinitions.length > 0) {
                        try {
                            // Get document class name
                            var documentClass = null;
                            
                            if (attributeDefinitions[0] && attributeDefinitions[0].contentClass) {
                                documentClass = attributeDefinitions[0].contentClass.id;
                            } else if (item && item.contentClass) {
                                documentClass = item.contentClass.name;
                            }
                            
                            console.log("[CNBPropertyEditorEDSPlugin] Document class:", documentClass);
                            
                            if (documentClass && editorConfig[documentClass]) {
                                var classConfig = editorConfig[documentClass];
                                
                                // STEP 1: Hide properties if hideProperties is configured
                                if (classConfig.hideProperties && classConfig.hideProperties.length > 0) {
                                    console.log("[CNBPropertyEditorEDSPlugin] ✓ Hide properties configured:", classConfig.hideProperties);
                                    
                                    var visibleAttributes = [];
                                    
                                    attributeDefinitions.forEach(function(attr) {
                                        var propertyName = attr.id || attr.name;
                                        
                                        // Check if this property should be hidden
                                        var shouldHide = classConfig.hideProperties.indexOf(propertyName) !== -1;
                                        
                                        if (shouldHide) {
                                            console.log("[CNBPropertyEditorEDSPlugin]   ✗ Hiding property:", propertyName);
                                        } else {
                                            visibleAttributes.push(attr);
                                        }
                                    });
                                    
                                    console.log("[CNBPropertyEditorEDSPlugin] ✓ Properties filtered successfully");
                                    console.log("[CNBPropertyEditorEDSPlugin]   Before hiding: " + attributeDefinitions.length + " properties");
                                    console.log("[CNBPropertyEditorEDSPlugin]   After hiding: " + visibleAttributes.length + " properties");
                                    
                                    // Replace attributeDefinitions with filtered version
                                    attributeDefinitions = visibleAttributes;
                                }
                                
                                // STEP 2: Reorder properties if propertyDisplayOrder is configured
                                if (classConfig.propertyDisplayOrder && classConfig.propertyDisplayOrder.length > 0) {
                                    console.log("[CNBPropertyEditorEDSPlugin] ✓ Property display order configured:", classConfig.propertyDisplayOrder);
                                    
                                    // Reorder attributeDefinitions based on propertyDisplayOrder
                                    var orderedAttributes = [];
                                    var remainingAttributes = [].concat(attributeDefinitions); // Clone array
                                    
                                    // First, add properties in the specified order
                                    classConfig.propertyDisplayOrder.forEach(function(propertyName) {
                                        for (var i = 0; i < remainingAttributes.length; i++) {
                                            var attr = remainingAttributes[i];
                                            if (attr.id === propertyName || attr.name === propertyName) {
                                                orderedAttributes.push(attr);
                                                remainingAttributes.splice(i, 1);
                                                console.log("[CNBPropertyEditorEDSPlugin]   ✓ Ordered property:", propertyName);
                                                break;
                                            }
                                        }
                                    });
                                    
                                    // Then, add any remaining properties not in the display order (at the end)
                                    remainingAttributes.forEach(function(attr) {
                                        orderedAttributes.push(attr);
                                        console.log("[CNBPropertyEditorEDSPlugin]   + Added remaining property:", attr.id || attr.name);
                                    });
                                    
                                    console.log("[CNBPropertyEditorEDSPlugin] ✓ Properties reordered successfully");
                                    console.log("[CNBPropertyEditorEDSPlugin]   Original order: " + 
                                               attributeDefinitions.map(function(a) { return a.id || a.name; }).join(", "));
                                    console.log("[CNBPropertyEditorEDSPlugin]   New order: " + 
                                               orderedAttributes.map(function(a) { return a.id || a.name; }).join(", "));
                                    
                                    // Replace attributeDefinitions with ordered version
                                    attributeDefinitions = orderedAttributes;
                                }
                            }
                        } catch (e) {
                            console.error("[CNBPropertyEditorEDSPlugin] Error reordering properties:", e);
                        }
                    }
                    
                    // Call original renderAttributes with (possibly reordered) attributeDefinitions
                    return original.call(this, attributeDefinitions, item, reason, isReadOnly, params);
                };
            });
            
            console.log("[CNBPropertyEditorEDSPlugin] ✓ Property display order interception set up successfully");
            
        } catch (e) {
            console.error("[CNBPropertyEditorEDSPlugin] Failed to set up property display order:", e);
        }
    });
    
    console.log("[CNBPropertyEditorEDSPlugin] Plugin initialized successfully");
    console.log("[CNBPropertyEditorEDSPlugin] ====================================");
});
